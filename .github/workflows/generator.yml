name: Generate Index

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate nested index.html
        run: |
          python <<'EOF'
          import os
          import re
          import urllib.parse

          # 1. ë§¤í•‘ ì¤€ë¹„ ë° í•¨ìˆ˜ ì •ì˜
          link_map = {}
          skyrim_pack_names = ["ë·°ë¦¬ë‹¤", "ì• ë‹ˆë¦¼", "ì§¬ë½•ë¦¼", "ë‰´ìƒë¦¼", "mzíŒ©", "ë¡œì–´ë¦¼", "Ferry"]
          fallout_pack_names = ["ì§¬í†µíŒ©", "ìŠ¤ìœ„íŠ¸í´"]

          def inject_width_style(filepath, link_map_data):
              try:
                  with open(filepath, 'r', encoding='utf-8', errors='ignore') as f:
                      content = f.read()

                  def link_replacer(match):
                      aid = match.group(1)
                      if aid in link_map_data:
                          # ë„ë©”ì¸ ì£¼ì†Œë¥¼ ë¹¼ê³  ìƒëŒ€ ê²½ë¡œë¡œ ì—°ê²° (404 ë°©ì§€ í•µì‹¬)
                          target = urllib.parse.quote(link_map_data[aid])
                          return f'href="./{target}"'
                      return match.group(0)

                  content = re.sub(r'href="?https://arca\.live/b/[^/"\'\s> ]+/(\d+)[^"\'\s> ]*"?', link_replacer, content)
                  for nick in ["Ryl3", "ryl3", "RYL3"]:
                      content = content.replace(nick, "")
                  
                  style_tag = '\n<style>body, .fr-view { max-width: 100% !important; width: 100% !important; margin: 0 !important; padding: 10px !important; } img { max-width: 100% !important; height: auto !important; }</style>\n'
                  if '<head>' in content.lower():
                      content = re.sub(r'(<head.*?>)', r'\1' + style_tag, content, flags=re.IGNORECASE)
                  
                  content = re.sub(r'<meta[^>]*Content-Security-Policy[^>]*>', '', content, flags=re.IGNORECASE)

                  with open(filepath, 'w', encoding='utf-8') as f:
                      f.write(content)
                  return True
              except:
                  return False
                  
          def fix_all_links(filepath):
              try:
                  with open(filepath, 'r', encoding='utf-8', errors='ignore') as f:
                      content = f.read()
                  
                  # 1ë‹¨ê³„: í•œê¸€ ì¸ì½”ë”© ì •ê·œí™” (NFCë¡œ ê°•ì œ ê³ ì •)
                  # ì„œë²„ê°€ ë¦¬ëˆ…ìŠ¤(NFD)ì—¬ë„ ë§í¬ëŠ” ë¬´ì¡°ê±´ ìœˆë„ìš° í‘œì¤€(NFC)ìœ¼ë¡œ ìƒì„±í•˜ê²Œ í•¨
                  def normalize_match(match):
                      url = match.group(1)
                      # ì£¼ì†Œì˜ í•œê¸€ ë¶€ë¶„ì„ NFCë¡œ ë³€í™˜
                      normalized_url = unicodedata.normalize('NFC', url)
                      return f'href="{normalized_url}"'

                  # 2ë‹¨ê³„: ë„ë©”ì¸ ë° ìƒëŒ€ê²½ë¡œ í†µí•© ìˆ˜ì •
                  # ì˜ëª»ëœ ë„ë©”ì¸ ì£¼ì†Œ ìˆ˜ì •
                  new = re.sub(
                      r'href="https://vapingexperienc3-max\.github\.io/(?!Tullius-ferry/)([^"]+)"',
                      r'href="https://vapingexperienc3-max.github.io/Tullius-ferry/\1"',
                      content
                  )
                  
                  # ì•ì˜ ìŠ¬ë˜ì‹œ(/) ì œê±° ë° ìƒëŒ€ê²½ë¡œí™”
                  new = re.sub(
                      r'href="/(?!/|http|https|Tullius-ferry)([^"]+)"',
                      r'href="\1"',
                      new
                  )

                  # ëª¨ë“  href ì£¼ì†Œ ë‚´ì˜ í•œê¸€ì„ NFCë¡œ ìµœì¢… ì •ê·œí™”
                  new = re.sub(r'href="([^"]+)"', normalize_match, new)

                  if new != content:
                      with open(filepath, 'w', encoding='utf-8') as f:
                          f.write(new)
                      return True
              except:
                  pass
              return False

          # 2. íŒŒì¼ íƒìƒ‰ ë° ë§¤í•‘ (1ì°¨ ìˆœíšŒ)
          print("--- 1ë‹¨ê³„: íŒŒì¼ íƒìƒ‰ ë° ë§¤í•‘ ì‹œì‘ ---")
          print(f"Current Directory: {os.getcwd()}")
          
          for root, dirs, files in os.walk('.'):
              # ìˆ¨ê¹€ í´ë”ë‚˜ .git ë“± ì œì™¸
              dirs[:] = [d for d in dirs if not d.startswith('.')]
              for f in files:
                  if f.endswith('.html') and f not in ['index.html', '404.html']:
                      path = os.path.join(root, f)
                      print(f"ğŸ” íŒŒì¼ ê°ì§€: {f}")  # ì¼ë‹¨ íŒŒì¼ì„ ì°¾ìœ¼ë©´ ë¬´ì¡°ê±´ ì¶œë ¥
                      
                      aid = None
                      # íŒŒì¼ëª…ì—ì„œ ìˆ«ì ì¶”ì¶œ (7~11ìë¦¬)
                      nums = re.findall(r'\d{7,11}', f)
                      if nums: 
                          aid = nums[0]
                      
                      # íŒŒì¼ëª…ì— ìˆ«ìê°€ ì—†ìœ¼ë©´ ë³¸ë¬¸ ì•ë¶€ë¶„ì—ì„œ ì¶”ì¶œ
                      if not aid:
                          try:
                              with open(path, 'r', encoding='utf-8', errors='ignore') as tmp:
                                  # ì²˜ìŒ 5000ìë§Œ ì½ì–´ì„œ ì•„ì¹´ ë§í¬ íƒìƒ‰
                                  m = re.search(r'arca\.live/b/[^/]+/(\d+)', tmp.read(5000))
                                  if m: aid = m.group(1)
                          except: pass
                      
                      if aid:
                          rel_p = os.path.relpath(path, '.').replace('\\', '/')
                          link_map[aid] = rel_p
                          print(f"ğŸ”— ë§¤í•‘ ì„±ê³µ: {aid} -> {rel_p}")
                      else:
                          # ë§¤í•‘ì— ì‹¤íŒ¨í–ˆë‹¤ë©´ ì´ìœ  ì¶œë ¥
                          print(f"âš ï¸ ë§¤í•‘ ì‹¤íŒ¨: {f} ì—ì„œ ê²Œì‹œê¸€ ë²ˆí˜¸(AID)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ")

          # 3. ì‹¤ì œ ìˆ˜ì • ì‘ì—… ì‹¤í–‰ (2ì°¨ ìˆœíšŒ)
          print(f"\n--- 2ë‹¨ê³„: ë³¸ë¬¸ ìˆ˜ì • ì‹œì‘ (ì´ {len(link_map)}ê°œ ëŒ€ìƒ) ---")
          for root, dirs, files in os.walk('.'):
              for f in files:
                  if f.endswith('.html') and f not in ['index.html', '404.html']:
                      full_p = os.path.join(root, f)
                      if inject_width_style(full_p, link_map):
                          # 2) í•œê¸€ ì¸ì½”ë”© ë° ë„ë©”ì¸ í†µí•© íŒ¨ì¹˜ ì‹¤í–‰
                          # ì´ í•¨ìˆ˜ê°€ Trueë¥¼ ë°˜í™˜í•˜ë©´ ì§„ì§œë¡œ íŒŒì¼ ë‚´ìš©ì´ ë°”ë€ ê²ƒì…ë‹ˆë‹¤.
                          if fix_all_links(full_p):
                              print(f"âœ”ï¸ ìµœì¢… íŒ¨ì¹˜ ì™„ë£Œ (ìˆ˜ì •ë¨): {full_p}")
                          else:
                              # ìŠ¤íƒ€ì¼ì€ ë°”ê¿¨ëŠ”ë° ë§í¬ëŠ” ê³ ì¹  ê²Œ ì—†ì—ˆì„ ê²½ìš°
                              print(f"âœ”ï¸ ìŠ¤íƒ€ì¼ ì ìš© ì™„ë£Œ: {full_p}")
                      else:
                          # ì•„ì˜ˆ ì½ê¸° ì‹¤íŒ¨í•˜ê±°ë‚˜ ìŠ¤í‚µëœ ê²½ìš°
                          print(f"âŒ ì‘ì—… ìŠ¤í‚µ: {full_p}")

          # 4. íŠ¸ë¦¬ ìƒì„± ë° ì¸ë±ìŠ¤ ì œì‘ ë¡œì§ ì‹œì‘
          tree = {}
          for root, dirs, files in sorted(os.walk('.')):
              dirs[:] = [d for d in dirs if not d.startswith('.')]
              html_files = [f for f in files if f.endswith('.html') and f != 'index.html']
              rel_path = os.path.relpath(root, '.')
              if rel_path == "." or rel_path.startswith('.'): continue
              parts = rel_path.split(os.sep)
              curr = tree
              for p in parts:
                  if p not in curr: curr[p] = {'_files': [], '_dirs': {}}
                  curr = curr[p]['_dirs']
              curr_node = tree
              for p in parts[:-1]: curr_node = curr_node[p]['_dirs']
              curr_node[parts[-1]]['_files'] = sorted(html_files)

          def render_tree(node_name, node_data, depth, is_rr, full_path):
              icon = "pipboy.png" if is_rr else "ElderScroll.webp"
              text_color = "#FFB000" if is_rr else "#fff"
              bg_color = "rgba(0,0,0,0.6)"
              border_color = "rgba(255,176,0,0.3)" if is_rr else "rgba(255,255,255,0.1)"
              img_w = "45px" if is_rr else "55px"
              img_style = f"width:{img_w}; aspect-ratio:1/1; object-fit:contain; margin-right:12px; vertical-align:middle;"
              if is_rr: img_style += " margin-top:-2px;" # ì›ë³¸ ìƒ‰ìƒ ìœ ì§€ë¥¼ ìœ„í•´ í•„í„° ì œì™¸
              
              margin = f"margin-left:{depth * 15}px;"
              html = f"<div style='{margin} margin-bottom:12px; width:100%;' class='tree-node'>"
              html += f"<details open style='background:{bg_color}; border:1px solid {border_color}; border-radius:12px; overflow:hidden;'>"
              html += f"<summary style='padding:15px; font-weight:bold; color:{text_color}; cursor:pointer; list-style:none; display:flex; align-items:center; background:rgba(255,255,255,0.03); border-bottom:1px solid {border_color};'>"
              html += f"<img src='{icon}' style='{img_style}'>{node_name}</summary>"
              html += "<ul style='margin:0; padding:15px 25px 20px 45px; list-style-type:none;'>"
              
              for f in node_data['_files']:
                  f_path = os.path.join(full_path, f)
                  url = f_path.replace(os.sep, '/')
                  disp = f.replace('.html', '').split(' (')[0].replace(' - íˆ´ë¦¬ìš°ìŠ¤ ì±„ë„', '')
                  f_icon = f"<img src='pipboy.png' style='width:25px; margin-right:10px; vertical-align:middle;'>" if is_rr else f"<img src='ElderScroll.webp' style='width:30px; margin-right:10px; vertical-align:middle;'>"
                  link_class = "file-link-v" if is_rr else "file-link-f"
                  html += f'<li style="margin:12px 0;"><a href="{url}" target="_blank" class="{link_class}">{f_icon}{disp}</a></li>'
              
              html += "</ul>"
              for child_name, child_data in node_data['_dirs'].items():
                  html += render_tree(child_name, child_data, depth+1, is_rr, os.path.join(full_path, child_name))
              html += "</details></div>"
              return html

          main_contents = {"ferry": "", "railroad": ""}
          sidebar_data = {"ferry": {"modpack": "", "normal": ""}, "railroad": {"modpack": "", "normal": ""}}
          for top_folder, data in tree.items():
              is_rr = any(k in top_folder.upper() for k in ["FALLOUT", "í´ì•„ì›ƒ"]) or any(k in top_folder for k in fallout_pack_names)
              theme_key = "railroad" if is_rr else "ferry"
              fid = "f-" + "".join(filter(str.isalnum, top_folder))
              main_contents[theme_key] += f"<div id='{fid}' class='cat-content' style='display:none; width:100%;'>" + render_tree(top_folder, data, 0, is_rr, top_folder) + "</div>"
              is_modpack = any(k in top_folder for k in skyrim_pack_names + fallout_pack_names) or "[ëª¨ë“œíŒ©]" in top_folder
              category = "modpack" if is_modpack else "normal"
              link_cls = "sidebar-link-v" if is_rr else "sidebar-link-f"
              sidebar_data[theme_key][category] += f"<a href='javascript:void(0)' onclick='showCat(\"{fid}\")' class='sidebar-link {link_cls}' id='l-{fid}'>- {top_folder}</a>"

          with open('index.html', 'w', encoding='utf-8') as f:
              f.write("<!DOCTYPE html><html lang='ko'><head><meta charset='UTF-8'><title>Tullius' Archive</title><style>")
              f.write("html { overflow-y: scroll; scroll-behavior: smooth; }")
              f.write("body { margin:0; min-height:100vh; background-color:#000; font-family:sans-serif; color:#eee; overflow-x:hidden; transition:0.4s; background-attachment: fixed !important; background-size: cover !important; }")
              f.write("a, a:link, a:visited { text-decoration: none !important; color: inherit !important; }")
              f.write(".sidebar-link { display:block; padding:10px 0; font-size:0.95em; border-bottom:1px solid rgba(255,255,255,0.05); transition:0.3s; cursor:pointer; }")
              f.write(".sidebar-link-f { color:#aaa !important; transition: 0.3s; }")
              f.write(".sidebar-link-f:hover, .sidebar-link-f.active { color:#fff !important; padding-left:12px; text-shadow: 0 0 10px rgba(255,255,255,0.8), 0 0 20px rgba(0,200,255,0.5); }")
              f.write(".sidebar-link-v { color:#b37d00 !important; } .sidebar-link-v:hover, .sidebar-link-v.active { color:#FFB000 !important; padding-left:5px; }")
              f.write(".top-header { position:fixed; top:0; left:0; width:100%; height:70px; background:rgba(0,0,0,0.95); display:flex; align-items:center; justify-content:center; line-height: 1; z-index:1000; border-bottom:2px solid rgba(255,255,255,0.1); backdrop-filter:blur(5px); }")
              f.write(".header-container { width:100%; max-width:1400px; display:flex; justify-content:space-between; align-items:center; padding:0 40px; box-sizing:border-box; }")
              f.write(".header-btn { background:rgba(255,255,255,0.03); border:1px solid; border-radius:6px; padding:0 18px; height:42px; font-weight:bold; font-size:0.95em; display:inline-flex; align-items:center; gap:8px; transition:0.3s; cursor:pointer; color:inherit !important; justify-content:center; box-sizing:border-box; }")
              f.write("#btn-f:hover { background:rgba(255,255,255,0.15) !important; border-color:#fff !important; box-shadow: 0 0 15px #fff; transform:translateY(-2px); }")
              f.write("#btn-v:hover { background:rgba(255,176,0,0.15) !important; border-color:#FFB000 !important; box-shadow: 0 0 15px #FFB000; transform:translateY(-2px); }")
              f.write(".sidebar-nav { width:330px; position:fixed; top:110px; left:40px; height:calc(100vh - 150px); background:rgba(0,0,0,0.85); border:1px solid #444; border-radius:8px; padding:25px; overflow-y:auto; z-index:100; opacity:0; visibility:hidden; transition:0.3s; box-sizing:border-box; }")
              f.write(".sidebar-nav.active { opacity:1; visibility:visible; }")
              f.write(".main-area { margin-left:420px; padding:110px 60px 50px 0; position:relative; z-index:10; width:calc(100% - 480px); max-width:1200px; box-sizing:border-box; }")
              f.write("#search-bar { width:100%; box-sizing:border-box; padding:16px 25px; border-radius:30px; border:1px solid #444; background:rgba(255,255,255,0.05); color:#fff; margin:25px 0; outline:none; transition:0.3s; }")
              f.write(".file-link-f { color: #ccc !important; transition:0.2s; }")
              f.write(".file-link-f:hover { color:#ffffff !important; text-shadow: 0 0 8px #fff, 0 0 15px rgba(0,210,255,1), 0 0 30px rgba(0,150,255,0.8); }")
              f.write(".file-link-v { color: #d4a017 !important; transition:0.2s; }")
              f.write(".file-link-v:hover { color: #FFB000 !important; text-shadow: 0 0 12px rgba(255,176,0,0.9); }")
              f.write(".modal { display:none; position:fixed; z-index:3000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.9); backdrop-filter:blur(15px); }")
              f.write(".modal-content { background:#111; margin:5% auto; padding:50px; border:1px solid #333; border-radius:15px; width:90%; max-width:1000px; position:relative; max-height:85vh; overflow-y:auto; box-sizing:border-box; }")
              f.write("</style></head><body>")
              f.write("<style>")
              f.write("  .nav-btn { background:none; border:none; color:#888; cursor:pointer; font-size:0.9em; transition:0.2s; padding:5px; vertical-align:middle; }")
              f.write("  .nav-btn:hover { color:#fff; transform: scale(1.1); }")
              f.write("</style>")
              f.write("<div id='bgm-player' style='position:fixed; bottom:20px; right:40px; background:rgba(0,0,0,0.85); border:1px solid rgba(255,255,255,0.15); border-radius:30px; padding:8px 18px; display:flex; align-items:center; gap:12px; z-index:3000; backdrop-filter:blur(10px); box-shadow:0 4px 15px rgba(0,0,0,0.5);'>")
              f.write("<span id='track-info' style='font-size:0.82em; color:#bbb; min-width:140px; ...'>ì¬ìƒ ì¤€ë¹„ ì™„ë£Œ</span>")
              f.write("<a href='https://www.serpentsoundstudios.com' target='_blank' title='Music by Alexander Nakarada' style='font-size:10px; color:#555 !important; margin-left:-10px;'>â“˜</a>")
              f.write("<button onclick='changeTrack(-1)' class='nav-btn'>â—€â—€</button>") 
              f.write("<button onclick='togglePlay()' id='play-btn' style='background:none; border:none; color:#fff; cursor:pointer; font-size:1.1em; width:25px;'>â–¶</button>")
              f.write("<button onclick='changeTrack(1)' class='nav-btn'>â–¶â–¶</button>")
              f.write("<input type='range' id='volume-slider' min='0' max='1' step='0.01' value='0.5' style='width:70px; cursor:pointer; accent-color:#fff;'>")
              f.write("<audio id='main-audio'></audio></div>")

              # ê°€ì´ë“œ/í›„ê¸° (ê³ ì •)
              f.write("<div id='guideModal' class='modal'><div class='modal-content'><span style='position:absolute; top:20px; right:25px; font-size:28px; cursor:pointer; color:#666;' onclick='closeModal()'>&times;</span><h3 id='modal-t' style='margin-top:0; font-size:1.8em;'>ğŸ“œ ê°€ì´ë“œ ë° í›„ê¸°</h3><div style='color:#ddd; line-height:2; font-size:1.05em;'><p><strong>ğŸ’¡ ì´ìš© íŒ:</strong><br>")
              f.write("<span style='margin-bottom:12px; display:block;'>- ëŒ€ë¶€ë¶„ì˜ íŒŒì¼ì€ HTML ì–‘ì‹ìœ¼ë¡œ ë°±ì—…ë˜ì–´ ìˆìŠµë‹ˆë‹¤. <strong>(ê¸°ìˆ ì  í•œê³„ë¡œ ì˜ìƒì€ ì¶œë ¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)</strong></span>")
              f.write("<span style='margin-bottom:12px; display:block;'>- <strong>ì§ˆë¬¸, í”¼ë“œë°±, ë¡œê·¸</strong>ì˜ ê²½ìš° ì¼ì¼íˆ ë²„ì „ì´ë‚˜ ë¬¸ì œ ìœ í˜•ì„ êµ¬ë¶„í•˜ê¸° ì–´ë ¤ì›Œ <strong>í´ë” í•˜ë‚˜ì— êµ¬ë¶„ì—†ì´ ë„£ì—ˆìŠµë‹ˆë‹¤.</strong> ì–‘í•´ ë°”ëë‹ˆë‹¤.</span>")
              f.write("<span style='margin-bottom:12px; display:block;'>- <strong>ë¯¸í•´ê²° íƒ­</strong>ì˜ ê²½ìš° í•´ê²°ë˜ì§€ ì•Šì•˜ë‹¤ê³  ìƒê°ë˜ëŠ” ì´ìŠˆë“¤ì„ ë°±ì—…í•´ ë†“ì•˜ìŠµë‹ˆë‹¤. <strong>í•´ê²°ëœ ë¬¸ì œê°€ ìˆìœ¼ë©´ í”¼ë“œë°± ë¶€íƒë“œë¦½ë‹ˆë‹¤.</strong></span>")
              f.write("<span style='margin-bottom:12px; display:block;'>- ìì˜í•œ í”½ìŠ¤ë‚˜ ë²ˆì—­ì€ ì›ë³¸ ëŒ€ì‹  HTML ë§í¬ë¡œ ë°±ì—…ë˜ì—ˆìœ¼ë©°, <strong>ì™¸ë¶€ ë§í¬(êµ¬ë“œ/ë©”ê°€)ê°€ í„°ì§€ëŠ” ê²½ìš°ëŠ” ëŒ€ì²˜ê°€ ì–´ë µìŠµë‹ˆë‹¤.</strong></span>")
              f.write("<span style='margin-bottom:12px; display:block;'>- <strong>ëª¨ë“œíŒ©, í”„ë¦¬ì…‹, ì˜ìƒ, ë™ë£Œ</strong> ë“± ì£¼ìš” ìë£ŒëŠ” í…Œë¼ë°•ìŠ¤ì— ì›ë³¸ìœ¼ë¡œ ë°±ì—…ë˜ì–´ ìˆìŠµë‹ˆë‹¤. <span style='color:#FFB000; font-weight:bold;'>(ì•”í˜¸ í™•ì¸ í•„ìˆ˜!)</span></span></p>")
              f.write("<p style='border-top:1px solid #333; padding-top:20px; margin-top:20px;'>")
              f.write("<strong>ğŸµ Music Credit:</strong><br>")
              f.write("<span style='font-size:0.9em; color:#aaa;'>All BGM composed by <strong>Alexander Nakarada</strong> (Serpentsound Studios)<br>")
              f.write("Licensed under Creative Commons BY 4.0<br>")
              f.write("<a href='https://www.serpentsoundstudios.com' target='_blank' style='color:#58a6ff !important;'>https://www.serpentsoundstudios.com</a></span></p>")
              f.write("<p style='border-top:1px solid #333; padding-top:20px; margin-top:20px;'><strong>âœï¸ í›„ê¸°:</strong><br>ê³µì¥ì¥ ì´ ê°œê°™ì€ ë…„, ë„ˆ ì•„ë‹ˆì—ˆìŒ ì´ê±° ì‹œì‘ë„ ì•ˆ í–ˆì–´ ì•Œì•„? ì•Œë©´ ì†Œë¸ê°€ë“œì—ì„œ ìš°ë¦´ ìœ„í•´ ìˆ ì”ì´ë‚˜ ë“¤ì–´ë‹¬ë¼ê³ . <br>íˆ´ë¶•ì´ë“¤ì€ ì•„í”„ì§€ ë§ê³ . ë„ˆë„¤ ì—†ì–´ì§€ë©´ 15ë…„ ë™ì•ˆ í›„ì†ì‘ ìœ ê¸°í•˜ëŠ” í† ë“œ ìƒˆë¼ ëˆ„ê°€ ìš•í•´ì£¼ëƒ?</p></div></div></div>")

              # í—¤ë”
              f.write("<header class='top-header'><div class='header-container'><div>")
              f.write("<button class='header-btn' id='btn-f' onclick='triggerTheme(\"ferry\")' style='border-color:#fff; color:#fff;'><img src='ship.PNG' style='width:22px; filter:invert(1) brightness(2); vertical-align:middle;'> Ferry (Skyrim)</button>")
              f.write("<button class='header-btn' id='btn-v' onclick='triggerTheme(\"vault\")' style='border-color:#FFB000; color:#FFB000;'><img src='railroad.png' style='width:18px; filter: invert(1) sepia(1) saturate(5) hue-rotate(-10deg); vertical-align:middle; margin-top:-2px;'> Railroad (Fallout)</button></div>")
              f.write("<div><button class='header-btn' style='border-color:#ccc; color:#ccc;' onclick='openModal()'>ğŸ“– ê°€ì´ë“œ & í›„ê¸°</button>")
              f.write("<a href='https://github.com/vapingexperienc3-max/Tullius-s-ferry/issues' target='_blank' class='header-btn' style='border-color:#58a6ff; color:#58a6ff;'>ğŸ“¢ í”¼ë“œë°± ì œë³´</a></div></div></header>")

              sf_final = f"<details open style='margin-bottom:15px;'><summary style='color:#fff; font-weight:bold; padding:5px 0; border-bottom:1px solid rgba(255,255,255,0.2); display:flex; align-items:center;'><img src='ElderScroll.webp' style='width:55px; margin-right:12px;'>ëª¨ë“œíŒ© ì•„ì¹´ì´ë¸Œ</summary><div style='padding-left:10px;'>{sidebar_data['ferry']['modpack']}</div></details>{sidebar_data['ferry']['normal']}"
              srr_final = f"<details open style='margin-bottom:15px;'><summary style='color:#FFB000; font-weight:bold; padding:5px 0; border-bottom:1px solid rgba(255,176,0,0.3); display:flex; align-items:center;'><img src='pipboy.png' style='width:40px; margin-right:12px;'>ëª¨ë“œíŒ© ì•„ì¹´ì´ë¸Œ</summary><div style='padding-left:10px;'>{sidebar_data['railroad']['modpack']}</div></details>{sidebar_data['railroad']['normal']}"

              f.write("<div id='main-wrapper' style='display:none;'><div class='sidebar-nav' id='main-lnb'><h3 id='idx-t' style='border-bottom:2px solid; padding-bottom:10px;'>INDEX</h3><div id='l-ferry'>" + sf_final + "</div><div id='l-vault' style='display:none;'>" + srr_final + "</div></div>")
              f.write("<div class='main-area'><h1 id='t-f' style='display:none; color:#fff; font-size:4.5em; margin:0;'>Tullius' Ferry</h1><h1 id='t-v' style='display:none; color:#FFB000; font-size:4.5em; margin:0;'>The Sole Survivor's Railroad</h1><input type='text' id='search-bar' placeholder='íŒŒì¼ ê²€ìƒ‰...' onkeyup='globalSearch()'><div id='a-ferry'>" + main_contents['ferry'] + "</div><div id='a-vault' style='display:none;'>" + main_contents['railroad'] + "</div></div></div>")
              
              f.write("<div id='welcome-screen' style='position: fixed; top: 70px; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 2000; overflow: hidden;'><img src='welcome page.png' style='width: 100%; height: 100%; object-fit: cover; filter: brightness(0.5);'><div style='position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; width: 100%;'><h1 style='color:#fff; font-size:3.5em; margin-bottom:10px;'>í™˜ì˜í•©ë‹ˆë‹¤, ë“œë˜ê³¤ë³¸ê³¼ ìƒì¡´ì ì—¬ëŸ¬ë¶„.ìƒë‹¨ì˜ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì•„ì¹´ì´ë¸Œë¡œ ì—°ê²°ë©ë‹ˆë‹¤</h1><p style='color:#ccc; font-size:1.6em;'>ê°€ì´ë“œ & í›„ê¸° ë²„íŠ¼ë„ í•œë²ˆì”© ëˆŒëŸ¬ì£¼ì„¸ìš”!</p></div></div>")
              
              f.write("<script>")
              # 1. ì´ˆê¸° ë³€ìˆ˜ ë° í…Œë§ˆ ì„¤ì •
              f.write("let currentTheme = 'ferry'; let themeColor = '#ffffff';") # ìŠ¤ì¹´ì´ë¦¼ ê¸°ë³¸ ì—°ê¸°ìƒ‰: í°ìƒ‰
              f.write("let particles = []; const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');")
              
              # 2. ìº”ë²„ìŠ¤ ì´ˆê¸°í™” ë° ë¬¸ì„œ ì‚½ì…
              f.write("function setupCanvas(){")
              f.write("  canvas.style.position='fixed'; canvas.style.top='0'; canvas.style.left='0';")
              f.write("  canvas.style.width='100%'; canvas.style.height='100%'; canvas.style.pointerEvents='none'; canvas.style.zIndex='1';")
              f.write("  canvas.width = window.innerWidth; canvas.height = window.innerHeight;")
              f.write("  document.body.appendChild(canvas);")
              f.write("}")
              
              f.write("function openModal(){ document.getElementById('guideModal').style.display='block'; }")
              f.write("function closeModal(){ document.getElementById('guideModal').style.display='none'; }")
              
              # 3. í…Œë§ˆ ì „í™˜ (ì—°ê¸° ìƒ‰ìƒ ë³€ê²½ í¬í•¨)
              f.write("function triggerTheme(m){")
              f.write("  currentTheme = m; themeColor = (m==='ferry') ? '#ffffff' : '#FFB000';")
              f.write("  document.getElementById('welcome-screen').style.display='none';")
              f.write("  document.getElementById('main-wrapper').style.display='flex';")
              f.write("  switchTheme(m); document.getElementById('main-lnb').classList.add('active');")
              f.write("  if(particles.length === 0) { setupCanvas(); initSmoke(); animate(); }")
              f.write("  if(window.syncMusicWithTheme) window.syncMusicWithTheme(m);")
              f.write("}")
              
              f.write("function switchTheme(m){ const b=document.body; if(m==='ferry'){ b.style.setProperty('background-image', \"linear-gradient(to top, rgba(0,0,0,0.8), rgba(0,0,0,0.4)), url('skyrim.png')\", 'important'); b.style.setProperty('background-position', 'center 10%', 'important'); document.getElementById('l-ferry').style.display='block'; document.getElementById('l-vault').style.display='none'; document.getElementById('t-f').style.display='block'; document.getElementById('t-v').style.display='none'; document.getElementById('a-ferry').style.display='block'; document.getElementById('a-vault').style.display='none'; } else { b.style.setProperty('background-image', \"linear-gradient(to top, rgba(0,0,0,0.8), rgba(0,0,0,0.4)), url('fallout.png')\", 'important'); b.style.setProperty('background-position', 'center top 70px', 'important'); document.getElementById('l-ferry').style.display='none'; document.getElementById('l-vault').style.display='block'; document.getElementById('t-f').style.display='none'; document.getElementById('t-v').style.display='block'; document.getElementById('a-ferry').style.display='none'; document.getElementById('a-vault').style.display='block'; } }")

              # 4. ì—°ê¸° íš¨ê³¼ ë¬¼ë¦¬ ë¡œì§
              f.write("class Particle { constructor(){ this.reset(); } reset(){ this.x = Math.random() * canvas.width; this.y = canvas.height + 150; this.size = Math.random() * 120 + 80; this.speedY = Math.random() * 0.7 + 0.4; this.speedX = Math.random() * 0.6 - 0.3; this.opacity = Math.random() * 0.15 + 0.05; this.rotation = Math.random() * Math.PI * 2; this.rotSpeed = Math.random() * 0.015 - 0.007; this.growth = Math.random() * 0.3 + 0.2; } update(){ this.y -= this.speedY; this.x += this.speedX + Math.sin(this.y * 0.005) * 0.5; this.size += this.growth; this.rotation += this.rotSpeed; this.opacity -= 0.0003; if(this.opacity <= 0 || this.y < -400) this.reset(); } draw(){ ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.rotation); ctx.globalCompositeOperation = 'screen'; let grad = ctx.createRadialGradient(0,0,0,0,0,this.size); grad.addColorStop(0, themeColor + Math.floor(this.opacity*255).toString(16).padStart(2,'0')); grad.addColorStop(0.5, themeColor + Math.floor(this.opacity*40).toString(16).padStart(2,'0')); grad.addColorStop(1, 'transparent'); ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(0,0,this.size,0,Math.PI*2); ctx.fill(); ctx.restore(); } }")
              f.write("function initSmoke(){ particles = []; for(let i=0; i<45; i++) particles.push(new Particle()); }")
              f.write("function animate(){ ctx.clearRect(0,0,canvas.width, canvas.height); particles.forEach(p=>{ p.update(); p.draw(); }); requestAnimationFrame(animate); }")
              f.write("window.onresize = ()=>{ canvas.width = window.innerWidth; canvas.height = window.innerHeight; };")

              f.write("function showCat(fid){ document.querySelectorAll('.cat-content').forEach(c=>c.style.display='none'); document.querySelectorAll('.sidebar-link').forEach(l=>l.classList.remove('active')); const target = document.getElementById(fid); if(target) target.style.display='block'; const link = document.getElementById('l-'+fid); if(link) link.classList.add('active'); window.scrollTo({top:0,behavior:'smooth'}); }")
              
              # 5. ê²€ìƒ‰ ë¡œì§ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
              f.write("function globalSearch(){ ")
              f.write("  let q = document.getElementById('search-bar').value.toLowerCase(); ")
              f.write("  let targetID = (currentTheme === 'ferry') ? 'a-ferry' : 'a-vault'; ")
              f.write("  let container = document.getElementById(targetID); ")
              f.write("  let cats = container.querySelectorAll('.cat-content'); ")
              f.write("  if(q === ''){ cats.forEach(cat => { cat.style.display = 'none'; cat.querySelectorAll('li, .tree-node').forEach(el => el.style.display = 'block'); cat.querySelectorAll('details').forEach(d => d.open = true); }); switchTheme(currentTheme); return; } ")
              f.write("  container.style.display = 'block'; ")
              f.write("  cats.forEach(cat => { ")
              f.write("    let fileLinks = cat.querySelectorAll('a[class^=\"file-link-\"]'); let catHasMatch = false; ")
              f.write("    fileLinks.forEach(a => { let li = a.parentElement; if(a.innerText.toLowerCase().includes(q)){ li.style.setProperty('display', 'block', 'important'); catHasMatch = true; } else { li.style.setProperty('display', 'none', 'important'); } }); ")
              f.write("    cat.querySelectorAll('.tree-node').forEach(node => { let nodeHasMatch = Array.from(node.querySelectorAll('li')).some(li => li.style.display !== 'none'); if(nodeHasMatch){ node.style.setProperty('display', 'block', 'important'); node.querySelector('details').open = true; } else { node.style.setProperty('display', 'none', 'important'); } }); ")
              f.write("    cat.style.display = catHasMatch ? 'block' : 'none'; ")
              f.write("  }); ")
              f.write("} \n") # globalSearch í•¨ìˆ˜ ë

              # --- í†µí•© BGM ë¡œì§ ì‹œì‘ ---
              f.write("const playlists = {\n")
              f.write("  skyrim: [\n")
              f.write("    {name:'1. Adventure', file:'1.Adventure(remaster).mp3'},\n")
              f.write("    {name:'2. Marked', file:'2.Marked.mp3'},\n")
              f.write("    {name:'3. Forest Walk', file:'3.Forest_Walk.mp3'},\n")
              f.write("    {name:'4. The Lone Wolf', file:'4.The_Lone_Wolf.mp3'},\n")
              f.write("    {name:'5. Dragonquest', file:'5.Dragonquest.mp3'},\n")
              f.write("    {name:'6. Daudir', file:'6.Daudir.mp3'},\n")
              f.write("    {name:'7. Hymn to the Gods', file:'7.Hymn_to_the_Gods.mp3'},\n")
              f.write("    {name:'8. The Road Home', file:'8.The_Road_Home_2023.mp3'},\n")
              f.write("    {name:'9. Mjolnir', file:'9.Mjolnir.mp3'},\n")
              f.write("    {name:'10. Adventure(Metal)', file:'10.Adventure(Metal_Version).mp3'}\n")
              f.write("  ],\n")
              f.write("  fallout: [\n")
              f.write("    {name:'1. Happy', file:'1.Happy.mp3'},\n")
              f.write("    {name:'2. Degenerate Blues', file:'2.Degenerate_Blues.mp3'},\n")
              f.write("    {name:'3. Stoned', file:'3.Stoned(no_guitar_solo).mp3'},\n")
              f.write("    {name:'4. Be Chillin', file:'4.Be_Chillin.mp3'},\n")
              f.write("    {name:'5. Nightfall', file:'5.Nightfall.mp3'},\n")
              f.write("    {name:'6. Apocalypse Blues', file:'6.Apocalypse_Blues.mp3'},\n")
              f.write("    {name:'7. Through the Mist', file:'7.Through_the_Mist.mp3'},\n")
              f.write("    {name:'8. The Collapse', file:'8.The_Collapse.mp3'},\n")
              f.write("    {name:'9. Lullaby', file:'9.Lullaby.mp3'}\n")
              f.write("  ]\n")
              f.write("};\n")

              f.write("let currentMode = 'skyrim'; let currIdx = 0;\n")
              f.write("const audio = document.getElementById('main-audio');\n")
              f.write("const tInfo = document.getElementById('track-info');\n")
              f.write("const pBtn = document.getElementById('play-btn');\n")
              f.write("const vSld = document.getElementById('volume-slider');\n")

              # 1. loadTrack í•¨ìˆ˜ (ë…ë¦½)
              f.write("function loadTrack(mode, idx) {\n")
              f.write("  currentMode = mode;\n")
              f.write("  currIdx = idx;\n")
              f.write("  const track = playlists[mode][idx];\n")
              f.write("  audio.src = track.file;\n")
              f.write("  tInfo.innerText = track.name;\n")
              f.write("  audio.volume = vSld.value;\n")
              f.write("}\n")

              # 2. togglePlay í•¨ìˆ˜ ìˆ˜ì •
              f.write("window.togglePlay = function() {\n")
              f.write("  if(audio.paused) {\n")
              # ë§Œì•½ srcê°€ ë¹„ì–´ìˆê±°ë‚˜ ì´ˆê¸° ìƒíƒœë¼ë©´ ë‹¤ì‹œ í•œë²ˆ ë¡œë“œ ì‹œë„
              f.write("    if(!audio.src || audio.currentTime === 0) {\n")
              f.write("       loadTrack(currentMode, currIdx);\n")
              f.write("    }\n")
              f.write("    const playPromise = audio.play();\n")
              f.write("    if (playPromise !== undefined) {\n")
              f.write("      playPromise.then(_ => {\n")
              f.write("        pBtn.innerText = '\u23f8';\n") # ì¼ì‹œì •ì§€ ì•„ì´ì½˜
              f.write("      }).catch(e => {\n")
              f.write("        console.log('ì¬ìƒ ì‹¤íŒ¨:', e);\n")
              f.write("      });\n")
              f.write("    }\n")
              f.write("  } else {\n")
              f.write("    audio.pause();\n")
              f.write("    pBtn.innerText = 'â–¶';\n")
              f.write("  }\n")
              f.write("};\n")

              # í…Œë§ˆ ì „í™˜ ì‹œ í˜¸ì¶œí•  ì™¸ë¶€ í•¨ìˆ˜
              f.write("window.syncMusicWithTheme = function(theme) {\n")
              f.write("  const newMode = (theme === 'vault') ? 'fallout' : 'skyrim';\n")
              f.write("  if(currentMode !== newMode) {\n")
              f.write("    const wasPlaying = !audio.paused;\n")
              f.write("    loadTrack(newMode, 0);\n")
              f.write("    if(wasPlaying) audio.play();\n")
              f.write("  }\n")
              f.write("};\n")

              # ë‹¤ìŒ/ì´ì „ ê³¡ ë²„íŠ¼ í•¨ìˆ˜
              f.write("window.changeTrack = function(dir) {\n")
              f.write("  const list = playlists[currentMode];\n")
              f.write("  currIdx = (currIdx + dir + list.length) % list.length;\n")
              f.write("  const wasPlaying = !audio.paused;\n")
              f.write("  loadTrack(currentMode, currIdx);\n")
              # ë¸Œë¼ìš°ì € ì •ì±… ëŒ€ì‘: play()ê°€ ë¦¬í„´í•˜ëŠ” Promise ì²˜ë¦¬
              f.write("  if(wasPlaying) {\n")
              f.write("    const playPromise = audio.play();\n")
              f.write("    if (playPromise !== undefined) {\n")
              f.write("      playPromise.then(_ => { pBtn.innerText='â¸'; }).catch(error => { console.log('ì¬ìƒ ì°¨ë‹¨ë¨'); });\n")
              f.write("    }\n")
              f.write("  }\n")
              f.write("};\n")

              # ê³¡ ì¢…ë£Œ ì‹œ ìë™ ì¬ìƒ
              f.write("audio.onended = () => { \n")
              f.write("  const list = playlists[currentMode];\n")
              f.write("  currIdx = (currIdx + 1) % list.length;\n")
              f.write("  loadTrack(currentMode, currIdx);\n")
              f.write("  audio.play().catch(e => console.log('ìë™ì¬ìƒ ëŒ€ê¸°'));\n")
              f.write("};\n")
              
              f.write("vSld.oninput = () => { audio.volume = vSld.value; };\n")
              # [ì¤‘ìš”] ì´ˆê¸° ë¡œë“œ ì‹œ ì¬ìƒí•˜ì§€ ì•Šê³  'ì¤€ë¹„'ë§Œ í•´ë‘ 
              f.write("loadTrack('skyrim', 0);\n")
              
              # ì‚¬ìš©ìê°€ ì²« í´ë¦­ì„ í•  ë•Œ ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ë¥¼ í™œì„±í™”í•˜ëŠ” 'ì ê¸ˆ í•´ì œ' ë¡œì§
              f.write("document.addEventListener('click', () => {\n")
              f.write("  if (audio.src && audio.paused && currIdx === 0 && audio.currentTime === 0) {\n")
              # ì´ ë¶€ë¶„ì€ ì‚¬ìš©ìê°€ ì‚¬ì´íŠ¸ ì–´ë””ë“  ì²˜ìŒ í´ë¦­í•˜ë©´ ìŒì•…ì´ ì‹œì‘ë˜ê²Œ í•¨ (ì„ íƒ ì‚¬í•­)
              # f.write("    // audio.play().catch(e => {}); \n") 
              f.write("  }\n")
              f.write("}, {once: true});\n")
              # --- BGM ë¡œì§ ë ---
              f.write("</script></body></html>")
          EOF

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "FIX: Search logic to show all matching folders within current theme" || exit 0
          git push origin main
